# Antikythera - Google Anti Gravity Instructions

## Quick Start

### Main Entry Point
```java
Antikythera antk = Antikythera.getInstance();
antk.preProcess();
antk.generateApiTests();    // REST controllers  
antk.generateUnitTests();   // Services
```

## Core Architecture

**Three-Phase Pipeline:**
1. **Parser** (`AbstractCompiler`) - Parse Java source with JavaParser
2. **Evaluator** (`Evaluator`) - Symbolic execution engine
3. **Generator** (`TestGenerator`) - Generate JUnit tests

## Essential APIs

### Configuration
```java
Settings.loadConfigMap();
String basePath = Settings.getBasePath();
Collection<String> controllers = Settings.getPropertyList(Settings.CONTROLLERS, String.class);
```

### Parsing & Type Resolution
```java
// Check cache first
CompilationUnit cu = AntikytheraRunTime.getCompilationUnit(className);

// Or compile new
AbstractCompiler compiler = new AbstractCompiler();
compiler.compile(AbstractCompiler.classToPath(className));
cu = compiler.getCompilationUnit();

// Resolve type
TypeWrapper type = AbstractCompiler.findType(cu, "TypeName");
```

### Expression Evaluation
```java
Evaluator evaluator = EvaluatorFactory.create(className, Evaluator.class);
Variable result = evaluator.evaluateExpression(expression);
Object value = result.getValue();
```

### Query Conversion
```java
// HQL to SQL
HQLParserAdapter adapter = new HQLParserAdapter(cu, entityWrapper);
ConversionResult result = adapter.convertToNativeSQL("SELECT u FROM User u");

// Method name to SQL
List<String> components = MethodToSQLConverter.extractComponents("findByUsername");
StringBuilder sql = new StringBuilder();
MethodToSQLConverter.buildSelectAndWhereClauses(components, sql, "users");
```

## Key Classes

| Class | Purpose |
|-------|---------|
| `Antikythera` | Main entry point, orchestrates test generation |
| `AbstractCompiler` | Base parser, type resolution |
| `RestControllerParser` | Parse REST controllers |
| `ServicesParser` | Parse service classes |
| `RepositoryParser` | Parse JPA repositories |
| `Evaluator` | Expression evaluation engine |
| `EvaluatorFactory` | Create evaluator instances |
| `TestGenerator` | Abstract test generator |
| `SpringTestGenerator` | REST controller test generator |
| `UnitTestGenerator` | Service unit test generator |
| `Settings` | Configuration management |
| `AntikytheraRunTime` | Global runtime state & caches |
| `HQLParserAdapter` | HQL/JPQL to SQL conversion |
| `MethodToSQLConverter` | Spring Data method name to SQL |

## Common Tasks

**Task: Generate Tests for a Project**
```java
// 1. Configure in generator.yml (controllers, services, base_path, output_path)
// 2. Run generation
Antikythera antk = Antikythera.getInstance();
antk.preProcess();
antk.generateApiTests();
antk.generateUnitTests();
```

**Task: Parse and Analyze a Class**
```java
String className = "com.example.UserService";
CompilationUnit cu = AntikytheraRunTime.getCompilationUnit(className);
if (cu == null) {
    AbstractCompiler compiler = new AbstractCompiler();
    compiler.compile(AbstractCompiler.classToPath(className));
    cu = compiler.getCompilationUnit();
}
TypeWrapper type = AbstractCompiler.findType(cu, className);
```

**Task: Convert Repository Method to SQL**
```java
String methodName = "findByUsernameAndAgeGreaterThan";
List<String> components = MethodToSQLConverter.extractComponents(methodName);
StringBuilder sql = new StringBuilder();
boolean hasLimit = MethodToSQLConverter.buildSelectAndWhereClauses(
    components, sql, "users");
// sql: "SELECT * FROM users WHERE username = ? AND age > ? "
```

**Task: Convert HQL Query**
```java
EntityMappingResolver resolver = new EntityMappingResolver();
EntityMetadata metadata = resolver.resolveEntityMetadata(User.class);
HQLParserAdapter adapter = new HQLParserAdapter(cu, userEntityWrapper);
ConversionResult result = adapter.convertToNativeSQL("SELECT u FROM User u WHERE u.id = :id");
if (result.isSuccessful()) {
    String sql = result.getNativeSql();
    List<ParameterMapping> params = result.getParameterMappings();
}
```

## Configuration

Load from `generator.yml`:
```yaml
base_path: /path/to/project
output_path: /path/to/output
controllers:
  - com.example.UserController
services:
  - com.example.UserService
database:
  url: jdbc:postgresql://localhost:5432/db
  username: user
  password: pass
```

## Technology Stack

- **Java 21** - Language version
- **Maven** - Build tool
- **JavaParser 3.27.0** - AST parsing
- **ByteBuddy 1.15.3** - Dynamic class generation
- **Spring Boot 2.7.14** - Framework integration
- **hql-parser 0.0.15** - HQL/JPQL parsing (ANTLR4)

## Constraints & Requirements

- Java 21 with JVM flags: `--add-opens java.base/java.util.stream=ALL-UNNAMED`
- Test dependencies: `antikythera-sample-project` and `antikythera-test-helper` repos must be cloned
- Configuration: Always use `Settings` class, never hardcode paths
- Type resolution: Checks cache → CU → imports → package → java.lang → classpath → extra_exports

## Documentation
- **WARP.md** - Complete technical documentation (primary)
- **AGENT.md** - Quick reference guide
- **README.md** - Project overview

